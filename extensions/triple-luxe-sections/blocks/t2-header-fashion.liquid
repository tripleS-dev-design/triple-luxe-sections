
{%- assign classes = 'mk-header' -%}
{%- if block.settings.sticky -%}
  {%- assign classes = classes | append: ' mk-header--sticky' -%}
{%- endif -%}
{%- if block.settings.full_bleed -%}
  {%- assign classes = classes | append: ' mk-header--bleed' -%}
{%- endif -%}

<header class="{{ classes }}"
  style="
    --mk-primary: {{ block.settings.primary }};
    --mk-bg: {{ block.settings.bg }};
    --mk-fg: {{ block.settings.fg }};
    --mk-max: {{ block.settings.max_width }}px;
    --mk-logo-h: {{ block.settings.logo_height }}px;
    --mk-marquee-s: {{ block.settings.marquee_speed }}s;
    --mk-pad-x: {{ block.settings.pad_x }}px;
  ">

  {%- if block.settings.show_announce and block.settings.announce_text != blank -%}
  <div class="mk-topbar">
    <div class="mk-topbar__track" aria-hidden="true">
      <div class="mk-topbar__marquee">
        <span class="mk-topbar__text">{{ block.settings.announce_text }}</span>
        <span class="mk-topbar__text">{{ block.settings.announce_text }}</span>
        <span class="mk-topbar__text">{{ block.settings.announce_text }}</span>
      </div>
    </div>
  </div>
  {%- endif -%}

  <div class="mk-bar">
    <div class="mk-container mk-grid">

      <!-- Burger (mobile) -->
      <details class="mk-burger">
        <summary aria-label="Ouvrir le menu">☰</summary>
        <nav class="mk-nav mk-nav--mobile">
          {%- if block.settings.main_menu -%}
            {%- assign menu = linklists[block.settings.main_menu] -%}
            {%- if menu and menu.links.size > 0 -%}
              <ul>
                {%- for l in menu.links -%}
                  <li>
                    {%- if l.links and l.links.size > 0 -%}
                      <details>
                        <summary><a href="{{ l.url }}">{{ l.title }}</a></summary>
                        <ul>
                          {%- for c in l.links -%}
                            <li>
                              {%- if c.links and c.links.size > 0 -%}
                                <details>
                                  <summary><a href="{{ c.url }}">{{ c.title }}</a></summary>
                                  <ul>
                                    {%- for leaf in c.links -%}
                                      <li><a href="{{ leaf.url }}">{{ leaf.title }}</a></li>
                                    {%- endfor -%}
                                  </ul>
                                </details>
                              {%- else -%}
                                <a href="{{ c.url }}">{{ c.title }}</a>
                              {%- endif -%}
                            </li>
                          {%- endfor -%}
                        </ul>
                      </details>
                    {%- else -%}
                      <a href="{{ l.url }}">{{ l.title }}</a>
                    {%- endif -%}
                  </li>
                {%- endfor -%}
              </ul>
            {%- endif -%}
          {%- endif -%}
        </nav>
      </details>

      <!-- Logo (net, dimensionné via --mk-logo-h) -->
      {% assign logo_h = block.settings.logo_height | default: 40 %}
      <a class="mk-logo" href="{{ routes.root_url }}">
        {% if block.settings.logo != blank %}
          {{ block.settings.logo
            | image_url: width: 360
            | image_tag:
                alt: block.settings.brand,
                class: 'mk-logo__img',
                widths: '120,180,240,300,360,480,600',
                sizes: '(max-width: 1099px) 32px, 40px',
                loading: 'eager'
          }}
        {% else %}
          <span class="mk-logo__text">{{ block.settings.brand | escape }}</span>
        {% endif %}
      </a>

      <!-- Nav desktop -->
      <nav class="mk-nav mk-nav--desktop">
        {%- if block.settings.main_menu -%}
          {%- assign menu = linklists[block.settings.main_menu] -%}
          {%- if menu and menu.links.size > 0 -%}
            <ul class="mk-menu">
              {%- for l in menu.links -%}
                {%- if l.links and l.links.size > 0 -%}
                  <li class="mk-item mk-item--has-children">
                    <a class="mk-link" href="{{ l.url }}">{{ l.title }}</a>
                  </li>
                {%- else -%}
                  <li class="mk-item"><a class="mk-link" href="{{ l.url }}">{{ l.title }}</a></li>
                {%- endif -%}
              {%- endfor -%}
            </ul>
          {%- endif -%}
        {%- endif -%}
      </nav>

      <!-- CTA -->
      {%- if block.settings.cta_label != blank and block.settings.cta_url != blank -%}
      <a class="mk-cta" href="{{ block.settings.cta_url }}">{{ block.settings.cta_label }}</a>
      {%- endif -%}

      <!-- Utils -->
      <div class="mk-utils">
        {%- if block.settings.show_search -%}
          <a class="mk-util" href="{{ routes.search_url }}" aria-label="Rechercher">
            <svg width="20" height="20" viewBox="0 0 20 20" fill="none" aria-hidden="true"><circle cx="9" cy="9" r="7" stroke="currentColor" stroke-width="2"/><path d="M15 15l4 4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
          </a>
        {%- endif -%}
        {%- if block.settings.show_account -%}
          <a class="mk-util" href="{{ routes.account_url }}" aria-label="Mon compte">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><circle cx="12" cy="8" r="4" stroke="currentColor" stroke-width="2"/><path d="M4 20c1.5-4 6-6 8-6s6.5 2 8 6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
          </a>
        {%- endif -%}
        <a class="mk-util mk-cart" href="{{ routes.cart_url }}" aria-label="Panier">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none"><path d="M3 4h2l2.5 12H19l2-8H7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><circle cx="10" cy="20" r="1.6" fill="currentColor"/><circle cx="17" cy="20" r="1.6" fill="currentColor"/></svg>
          {%- if cart != empty and cart.item_count > 0 -%}
            <span class="mk-badge">{{ cart.item_count }}</span>
          {%- endif -%}
          {%- if block.settings.show_cart_total -%}
            <span class="mk-total">{{ cart.total_price | money }}</span>
          {%- endif -%}
        </a>
      </div>
    </div>
  </div>
</header>

<style>
/* Base & palette */
.mk-header{color:var(--mk-fg,#111); display:block}
.mk-header--sticky{position:sticky;top:0;z-index:40}
.mk-container{max-width:var(--mk-max,1200px);margin:0 auto;padding:0 var(--mk-pad-x,8px)}
/* Full-bleed interne (contenu) */
.mk-header--bleed .mk-container{max-width:none;width:100%}

/* === Full-bleed réel (casser "page-width" de Dawn) === */
.mk-header.mk-header--bleed{
  position: relative;
  left: 50%;
  right: 50%;
  margin-left: -50vw;
  margin-right: -50vw;
  width: 100vw;
  max-width: 100vw;
}
.mk-header.mk-header--bleed,
.mk-header.mk-header--bleed .mk-bar,
.mk-header.mk-header--bleed .mk-topbar{
  border-radius: 0 !important;
  box-shadow: none !important;
}

/* Topbar (marquee CSS) */
.mk-topbar{background:var(--mk-primary,#e11d2e);color:#fff;width:100%}
.mk-topbar__track{position:relative;overflow:hidden;width:100%}
.mk-topbar__marquee{
  display:inline-flex;gap:60px;white-space:nowrap;will-change:transform;
  animation: mk-marquee var(--mk-marquee-s,18s) linear infinite; padding:10px 0;
}
.mk-topbar__text{font-weight:800;letter-spacing:.2px;font-size:12px}
@keyframes mk-marquee{0%{transform:translateX(0)}100%{transform:translateX(-100%)}}

/* Barre principale */
.mk-bar{background:var(--mk-bg,#fff);border-bottom:1px solid #eee;width:100%}
.mk-grid{
  display:grid;align-items:center;gap:16px;
  grid-template-columns: 220px 1fr auto auto; /* logo | menu | cta | utils */
  padding:12px 0;
}

/* Logo (net, non déformé) */
.mk-logo{justify-self:start;display:inline-flex;align-items:center}
.mk-logo__img{
  height: var(--mk-logo-h, 40px);
  width: auto;
  max-height: var(--mk-logo-h, 40px);
  display:block;
  image-rendering:auto;
  -ms-interpolation-mode:bicubic;
}
.mk-logo__text{
  font-size:24px;line-height:1;font-weight:900;color:var(--mk-primary,#e11d2e);letter-spacing:2px
}

/* Nav desktop */
.mk-nav--desktop{display:none}
@media (min-width:1100px){
  .mk-nav--desktop{display:block}
  .mk-menu{display:flex;gap:22px;list-style:none;margin:0;padding:0}
  .mk-link{
    text-decoration:none;color:#1a1a1a;font-weight:800;font-size:13px;letter-spacing:.2px;
    position:relative;padding:8px 0;display:inline-flex;align-items:center;gap:6px;
  }
  .mk-item--has-children>.mk-link::after{content:"▾";font-size:12px;transform:translateY(-1px);opacity:.7}
  .mk-link:hover{color:var(--mk-primary,#e11d2e)}
}

/* CTA pill */
.mk-cta{
  display:inline-flex;align-items:center;justify-content:center;
  height:36px;padding:0 20px;border-radius:999px;
  background:radial-gradient(120% 120% at 30% 20%, #ff6b6b, var(--mk-primary,#e11d2e));
  box-shadow:0 8px 22px rgba(225,29,46,.35);
  color:#fff;text-decoration:none;font-weight:900;letter-spacing:.2px;
}

/* Utils (icônes) */
.mk-utils{display:flex;gap:16px;justify-content:flex-end;align-items:center}
.mk-util{color:#2b2b2b;text-decoration:none;display:inline-flex;align-items:center;position:relative}
.mk-util svg{display:block}
.mk-cart{gap:8px}
.mk-badge{
  position:absolute;top:-6px;right:-8px;min-width:18px;height:18px;padding:0 4px;
  border-radius:10px;background:var(--mk-primary,#e11d2e);color:#fff;font-size:12px;
  display:flex;align-items:center;justify-content:center;line-height:1;
}
.mk-total{font-weight:800;font-size:12px}

/* Burger + nav mobile (sans JS) */
.mk-burger{display:inline-flex}
.mk-burger>summary{
  list-style:none;border:1px solid #e5e7eb;border-radius:10px;padding:6px 10px;
  cursor:pointer;background:#fff;display:flex;align-items:center;
}
.mk-burger>summary::-webkit-details-marker{display:none}
.mk-nav--mobile{
  position:absolute;left:var(--mk-pad-x,8px);right:var(--mk-pad-x,8px);top:calc(100% + 10px);
  background:#fff;border:1px solid #e5e7eb;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.08);
  padding:12px;z-index:35;
}
.mk-nav--mobile ul{list-style:none;margin:0;padding:0;display:grid;gap:6px}
.mk-nav--mobile a{text-decoration:none;color:#111;font-weight:700}
.mk-nav--mobile details>summary{cursor:pointer;padding:8px 0}
.mk-nav--mobile details>summary a{pointer-events:none}
.mk-nav--mobile details[open]>summary{font-weight:900}

/* Responsive */
@media (max-width:1099px){
  .mk-grid{grid-template-columns:auto 1fr auto;gap:12px}
  .mk-nav--desktop,.mk-cta{display:none}
  .mk-logo__img{height:calc(var(--mk-logo-h,40px) - 8px);max-height:calc(var(--mk-logo-h,40px) - 8px)}
}
</style>

{% schema %}
{
  "name": "Header MARKA Style",
  "target": "section",
  "settings": [
    { "type": "text", "id": "brand", "label": "Nom de marque (fallback)", "default": "MARKA STORE" },
    { "type": "image_picker", "id": "logo", "label": "Logo" },
    { "type": "link_list", "id": "main_menu", "label": "Menu principal" },

    { "type": "checkbox", "id": "show_announce", "label": "Afficher la topbar", "default": true },
    { "type": "text", "id": "announce_text", "label": "Texte topbar", "default": "TARIFS DE LIVRAISON" },

    { "type": "text", "id": "cta_label", "label": "Bouton CTA — libellé", "default": "BACK TO SCHOOL" },
    { "type": "url",  "id": "cta_url",   "label": "Bouton CTA — URL", "default": "/collections/all" },

    { "type": "checkbox", "id": "show_search", "label": "Icône recherche", "default": true },
    { "type": "checkbox", "id": "show_account", "label": "Icône compte", "default": true },
    { "type": "checkbox", "id": "show_cart_total", "label": "Afficher total panier", "default": true },

    { "type": "checkbox", "id": "sticky", "label": "Header collant (sticky)", "default": true },
    { "type": "checkbox", "id": "full_bleed", "label": "Prendre toute la largeur (aux extrémités)", "default": true },

    { "type": "range", "id": "logo_height", "label": "Hauteur max du logo (px)", "min": 24, "max": 64, "step": 1, "default": 40 },
    { "type": "range", "id": "marquee_speed", "label": "Vitesse du texte topbar (sec)", "min": 6, "max": 30, "step": 1, "default": 18 },
    { "type": "range", "id": "pad_x", "label": "Padding horizontal (px)", "min": 0, "max": 24, "step": 2, "default": 8 },

    { "type": "color", "id": "primary", "label": "Couleur primaire", "default": "#e11d2e" },
    { "type": "color", "id": "bg", "label": "Fond barre principale", "default": "#ffffff" },
    { "type": "color", "id": "fg", "label": "Texte", "default": "#1a1a1a" },

    { "type": "range", "id": "max_width", "label": "Largeur max (px, si non full-bleed)", "min": 960, "max": 1600, "step": 10, "default": 1200 }
  ]
}
{% endschema %}
